---
- name: Deploy Backend via Ansible (produção)
  hosts: backend
  become: true
  collections:
    - community.docker

  vars:
    repo_url: 'https://github.com/wbrunovieira/revalidaItaliaBackNestJS.git'
    app_dir: /home/ubuntu/app

  pre_tasks:
    - name: Atualiza cache do apt
      apt:
        update_cache: yes

    - name: Garante Docker e plugin do Compose v2
      apt:
        name:
          - docker.io
          - docker-compose
        state: latest

    - name: Adiciona ubuntu ao grupo docker
      user:
        name: ubuntu
        groups: docker
        append: yes

  tasks:
    - name: Clona ou atualiza o código
      git:
        repo: '{{ repo_url }}'
        dest: '{{ app_dir }}'
        version: main
        force: yes
      become_user: ubuntu

    - name: Garante diretório de logs do Postgres
      file:
        path: '{{ app_dir }}/logs/db'
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Gera arquivo de ambiente (.env)
      template:
        src: 'templates/.env.prod.j2'
        dest: '{{ app_dir }}/.env'
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      become_user: ubuntu

    - name: Lista arquivos clonados
      ansible.builtin.shell: ls -R /home/ubuntu/app
      register: listagem

    - name: Exibe resultado
      ansible.builtin.debug:
        var: listagem.stdout_lines

    - name: Sobe containers (produção)
      become: yes
      become_user: ubuntu
      shell: |
        newgrp docker <<EONG
          cd /home/ubuntu/app
          docker-compose -f compose.prod.yml pull
          docker-compose -f compose.prod.yml up -d --build
        EONG

    - name: Roda migrações Prisma dentro do container
      shell: |
        cd {{ app_dir }}
        docker-compose -f compose.prod.yml exec -T backend npx prisma migrate deploy
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu

  handlers:
    - name: Reinicia stack Docker (Compose V2)
      shell: |
        cd {{ app_dir }}
        docker-compose -f compose.prod.yml up -d
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
