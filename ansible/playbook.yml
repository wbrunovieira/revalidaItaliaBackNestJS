---
- name: Deploy Backend via Ansible
  hosts: backend
  become: true
  collections:
    - community.docker

  vars:
    repo_url: 'https://github.com/wbrunovieira/revalidaItaliaBackNestJS.git'
    app_dir: /home/ubuntu/app

  pre_tasks:
    - name: Atualiza cache do apt
      apt: { update_cache: yes }

    - name: Garante que Docker e Compose estão instalados
      apt:
        name:
          - docker.io
          - docker-compose
        state: latest

    - name: Coloca ubuntu no grupo docker
      user:
        name: ubuntu
        groups: docker
        append: yes

  tasks:
    - name: Clona (ou atualiza) o código da aplicação
      git:
        repo: '{{ repo_url }}'
        dest: '{{ app_dir }}'
        version: main
        force: yes
      become_user: ubuntu

    - name: Garante diretório de logs do Postgres
      file:
        path: '{{ app_dir }}/logs/db'
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Roda migrações Prisma dentro do container
      community.docker.docker_compose_v2:
        project_src: '{{ app_dir }}'
        command: run --rm backend npx prisma migrate deploy
      become_user: ubuntu

    - name: Reconstrói e sobe containers com Docker Compose V2 (produção)
      shell: |
        cd {{ app_dir }}
        docker compose -f docker-compose.prod.yml pull
        docker compose -f docker-compose.prod.yml up -d --build
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
